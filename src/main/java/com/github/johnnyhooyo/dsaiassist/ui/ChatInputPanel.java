package com.github.johnnyhooyo.dsaiassist.ui;

import com.github.johnnyhooyo.dsaiassist.command.CommandProcessor;
import com.github.johnnyhooyo.dsaiassist.settings.PluginSettings;
import com.intellij.openapi.project.Project;
import com.intellij.ui.JBColor;
import com.intellij.ui.components.JBScrollPane;
import com.intellij.ui.components.JBTextArea;
import com.intellij.util.ui.JBUI;

import javax.swing.*;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import java.awt.*;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.util.List;
import java.util.function.Consumer;

/**
 * ËÅäÂ§©ËæìÂÖ•Èù¢Êùø - ÊµÆÁ™óÊ†∑Âºè
 */
public class ChatInputPanel extends JPanel implements ThemeAware {

    private final Consumer<String> onSendMessage;
    private final Runnable onClearChat;
    private final Runnable onNewChat;
    private final Project project;
    private final JBTextArea inputTextArea;
    private final JBScrollPane scrollPane;
    private final JButton sendButton;
    private final JPanel bottomBar;
    private final JButton settingsButton;
    private final JButton attachButton;
    private final JComboBox<String> modelComboBox;
    private final JPanel floatingContainer;
    private final CommandProcessor commandProcessor;
    private final AutoCompletePopup autoCompletePopup;
    private final AttachmentManager attachmentManager;

    public ChatInputPanel(Consumer<String> onSendMessage, Runnable onClearChat,
                         Runnable onNewChat, Project project) {
        super(new BorderLayout());
        this.onSendMessage = onSendMessage;
        this.onClearChat = onClearChat;
        this.onNewChat = onNewChat;
        this.project = project;

        // ÂàùÂßãÂåñÈôÑ‰ª∂ÁÆ°ÁêÜÂô®
        this.attachmentManager = new AttachmentManager(project);

        // ÂàùÂßãÂåñÂëΩ‰ª§Â§ÑÁêÜÂô®
        this.commandProcessor = new CommandProcessor(project, this::handleClearCommand, onNewChat, this::handleAttachmentCommand);
        this.autoCompletePopup = new AutoCompletePopup(this, this::insertSuggestion);
        
        inputTextArea = new JBTextArea();
        inputTextArea.setLineWrap(true);
        inputTextArea.setWrapStyleWord(true);
        inputTextArea.setRows(3);
        inputTextArea.setFont(inputTextArea.getFont().deriveFont(12f));

        scrollPane = new JBScrollPane(inputTextArea);
        scrollPane.setVerticalScrollBarPolicy(JBScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED);
        scrollPane.setHorizontalScrollBarPolicy(JBScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
        scrollPane.setPreferredSize(new Dimension(0, 80));
        scrollPane.setBorder(ThemeUtils.getNoBorder());
        scrollPane.setBackground(JBColor.DARK_GRAY);
//        scrollPane.getViewport().setBorder(ThemeUtils.getNoBorder());

        // ÂàùÂßãÂåñÂ∫ïÊ†èÊåâÈíÆ
        settingsButton = new JButton("‚öôÔ∏è");
        settingsButton.setToolTipText("ËÆæÁΩÆ");
        settingsButton.addActionListener(e -> showSettingsDialog());

        attachButton = new JButton("üìé");
        attachButton.setToolTipText("ÈôÑ‰ª∂ (" + attachmentManager.getAttachmentCount() + ")");
        attachButton.addActionListener(e -> showAttachmentDialog());

        // Ê®°ÂûãÈÄâÊã©‰∏ãÊãâÊ°Ü
        modelComboBox = new JComboBox<>(new String[]{"deepseek-chat", "deepseek-coder", "deepseek-reasoner"});
        modelComboBox.setSelectedItem(PluginSettings.getInstance().getDeepSeekModel());
        modelComboBox.addActionListener(e -> {
            String selectedModel = (String) modelComboBox.getSelectedItem();
            PluginSettings.getInstance().setDeepSeekModel(selectedModel);
        });

        sendButton = new JButton("ÂèëÈÄÅ");
        sendButton.addActionListener(e -> sendMessage());

        // Â∫ïÊ†èÂ∏ÉÂ±ÄÔºöËÆæÁΩÆÊåâÈíÆ(Â∑¶) | ÈôÑ‰ª∂ÊåâÈíÆ | ÂºπÁ∞ß | Ê®°ÂûãÈÄâÊã© | ÂèëÈÄÅÊåâÈíÆ(Âè≥)
        bottomBar = new JPanel();
        bottomBar.setPreferredSize(new Dimension(0, 35));
        bottomBar.setLayout(new BoxLayout(bottomBar, BoxLayout.X_AXIS));

        bottomBar.add(settingsButton);
        bottomBar.add(Box.createHorizontalStrut(5));
        bottomBar.add(attachButton);
        bottomBar.add(Box.createHorizontalGlue()); // ‰∏≠Èó¥ÂºπÁ∞ß
        bottomBar.add(modelComboBox);
        bottomBar.add(Box.createHorizontalStrut(5));
        bottomBar.add(sendButton);
        
        // ÂÜÖÈÉ®ÂÆπÂô®ÔºåÁî®‰∫éÂàõÂª∫ÊµÆÁ™óÊïàÊûú
        floatingContainer = new JPanel(new BorderLayout());
        floatingContainer.add(scrollPane, BorderLayout.CENTER);
        floatingContainer.add(bottomBar, BorderLayout.SOUTH);
        floatingContainer.setBorder(ThemeUtils.getFloatingBorder());
        
        setupLayout();
        setupKeyBindings();
        setupAutoComplete();
        updateTheme();
        // Ê≥®ÂÜå‰∏ªÈ¢òÂèòÂåñÁõëÂê¨
        ThemeChangeListener.getInstance().registerComponent(this);
    }
    
    private void setupLayout() {
        // Ê∑ªÂä†ÊµÆÁ™óÂÆπÂô®Âà∞‰∏ªÈù¢ÊùøÔºåÂπ∂Âú®Âë®Âõ¥ÁïôÂá∫ËæπË∑ù
        setBorder(JBUI.Borders.empty(10, 15, 15, 15));
        add(floatingContainer, BorderLayout.CENTER);
    }
    
    private void setupKeyBindings() {
        inputTextArea.addKeyListener(new KeyAdapter() {
            @Override
            public void keyPressed(KeyEvent e) {
                // È¶ñÂÖàÊ£ÄÊü•Ëá™Âä®ÂÆåÊàêÂºπÁ™óÊòØÂê¶Â§ÑÁêÜ‰∫ÜÊåâÈîÆ
                if (autoCompletePopup.handleKeyNavigation(e)) {
                    return;
                }

                if ((e.isControlDown() || e.isMetaDown()) && e.getKeyCode() == KeyEvent.VK_ENTER) {
                    // Ctrl+Enter Êàñ Cmd+Enter ÂèëÈÄÅÊ∂àÊÅØ
                    e.consume();
                    sendMessage();
                } else if (e.isShiftDown() && e.getKeyCode() == KeyEvent.VK_ENTER) {
                    // Shift+Enter Êç¢Ë°å - ÈªòËÆ§Ë°å‰∏∫ÔºåÂÖÅËÆ∏Êç¢Ë°å
                } else if (e.getKeyCode() == KeyEvent.VK_ENTER) {
                    // ÂçïÁã¨ÁöÑ Enter ÈîÆÂèëÈÄÅÊ∂àÊÅØ
                    e.consume();
                    sendMessage();
                } else if (e.getKeyCode() == KeyEvent.VK_ESCAPE) {
                    // ESCÈîÆÈöêËóèËá™Âä®ÂÆåÊàê
                    autoCompletePopup.setVisible(false);;
                }
            }
        });
    }

    private void setupAutoComplete() {
        if (!PluginSettings.getInstance().isEnableAutoComplete()) {
            return;
        }

        inputTextArea.getDocument().addDocumentListener(new DocumentListener() {
            @Override
            public void insertUpdate(DocumentEvent e) {
                SwingUtilities.invokeLater(() -> updateAutoComplete());
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                SwingUtilities.invokeLater(() -> updateAutoComplete());
            }

            @Override
            public void changedUpdate(DocumentEvent e) {
                SwingUtilities.invokeLater(() -> updateAutoComplete());
            }
        });
    }

    private void updateAutoComplete() {
        String text = inputTextArea.getText();
        String currentLine = getCurrentLine();

        if (currentLine.startsWith("/")) {
            List<String> suggestions = commandProcessor.getCommandSuggestions(currentLine);
            if (!suggestions.isEmpty()) {
                Point location = getCaretLocation();
                autoCompletePopup.showSuggestions(suggestions, location);
            } else {
                autoCompletePopup.setVisible(false);;
            }
        } else {
            autoCompletePopup.setVisible(false);;
        }
    }

    private String getCurrentLine() {
        try {
            int caretPos = inputTextArea.getCaretPosition();
            String text = inputTextArea.getText();
            int lineStart = text.lastIndexOf('\n', caretPos - 1) + 1;
            return text.substring(lineStart, caretPos);
        } catch (Exception e) {
            return "";
        }
    }

    private Point getCaretLocation() {
        try {
            Rectangle rect = inputTextArea.modelToView(inputTextArea.getCaretPosition());
            Point location = new Point(rect.x, rect.y + rect.height);
            SwingUtilities.convertPointToScreen(location, inputTextArea);
            return location;
        } catch (Exception e) {
            Point location = inputTextArea.getLocationOnScreen();
            return new Point(location.x, location.y + inputTextArea.getHeight());
        }
    }

    private void insertSuggestion(String suggestion) {
        String currentLine = getCurrentLine();
        if (currentLine.startsWith("/")) {
            try {
                int caretPos = inputTextArea.getCaretPosition();
                String text = inputTextArea.getText();
                int lineStart = text.lastIndexOf('\n', caretPos - 1) + 1;

                // ÊõøÊç¢ÂΩìÂâçË°å
                inputTextArea.replaceRange(suggestion, lineStart, caretPos);
            } catch (Exception e) {
                inputTextArea.setText(suggestion);
            }
        }
    }
    
    @Override
    public void updateTheme() {
        setBackground(ThemeUtils.getBackgroundColor());

        // Êõ¥Êñ∞ËæìÂÖ•Ê°Ü‰∏ªÈ¢ò
        inputTextArea.setBackground(ThemeUtils.getInputBackgroundColor());
        inputTextArea.setForeground(ThemeUtils.getEditorForegroundColor());

        // Êõ¥Êñ∞ÊªöÂä®Èù¢Êùø‰∏ªÈ¢ò
        scrollPane.setBackground(ThemeUtils.getInputBackgroundColor());
        scrollPane.getViewport().setBackground(ThemeUtils.getInputBackgroundColor());

        // Êõ¥Êñ∞ÊåâÈíÆ‰∏ªÈ¢ò
        Color buttonBg = ThemeUtils.getSelectedBackgroundColor();
        Color buttonFg = ThemeUtils.getForegroundColor();

        sendButton.setBackground(buttonBg);
        sendButton.setForeground(buttonFg);

        settingsButton.setBackground(buttonBg);
        settingsButton.setForeground(buttonFg);

        attachButton.setBackground(buttonBg);
        attachButton.setForeground(buttonFg);

        // Êõ¥Êñ∞Ê®°ÂûãÈÄâÊã©Ê°Ü‰∏ªÈ¢ò
        modelComboBox.setBackground(ThemeUtils.getInputBackgroundColor());
        modelComboBox.setForeground(ThemeUtils.getEditorForegroundColor());

        // Â∫ïÊ†èÊ†∑Âºè
        bottomBar.setBackground(ThemeUtils.getInputBackgroundColor());
        bottomBar.setBorder(BorderFactory.createMatteBorder(
                1, 0, 0, 0, ThemeUtils.getInputBorderColor() // È°∂ÈÉ®ÁªÜÁ∫øÂàÜÈöî
        ));

        // Êõ¥Êñ∞ÊµÆÁ™óÂÆπÂô®‰∏ªÈ¢ò
        floatingContainer.setBackground(ThemeUtils.getInputBackgroundColor());
        floatingContainer.setBorder(ThemeUtils.getFloatingBorder());

        // ÈáçÊñ∞ÁªòÂà∂ÁªÑ‰ª∂
        repaint();
    }
    
    private void sendMessage() {
        String message = inputTextArea.getText().trim();
        if (!message.isEmpty()) {
            // ÈöêËóèËá™Âä®ÂÆåÊàêÂºπÁ™ó
            autoCompletePopup.setVisible(false);;

            // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂëΩ‰ª§
            if (commandProcessor.isCommand(message)) {
                boolean handled = commandProcessor.processCommand(message);
                if (!handled) {
                    // ÊòæÁ§∫Êú™Áü•ÂëΩ‰ª§ÈîôËØØÔºå‰ΩÜ‰∏çÈÄöËøáonClearChat
                    System.err.println("Êú™Áü•ÂëΩ‰ª§: " + message);
                }
            } else {
                // ÊôÆÈÄöÊ∂àÊÅØÔºåÊ∑ªÂä†ÈôÑ‰ª∂ÂÜÖÂÆπ
                String fullMessage = message;
                if (attachmentManager.hasAttachments()) {
                    fullMessage += attachmentManager.generateAttachmentContent();
                    // ÂèëÈÄÅÂêéÊ∏ÖÁ©∫ÈôÑ‰ª∂
                    attachmentManager.clearAll();
                    updateAttachmentButton();
                }
                onSendMessage.accept(fullMessage);
            }

            inputTextArea.setText("");
            inputTextArea.requestFocus();
        }
    }

    private void showSettingsDialog() {
        SettingsDialog dialog = new SettingsDialog();
        if (dialog.showAndGet()) {
            // ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÊõ¥Êñ∞Ê®°ÂûãÈÄâÊã©Ê°Ü
            modelComboBox.setSelectedItem(PluginSettings.getInstance().getDeepSeekModel());
        }
    }

    private void showAttachmentDialog() {
        // ÁÆÄÂçïÁöÑÈôÑ‰ª∂ÁÆ°ÁêÜÂØπËØùÊ°Ü
        StringBuilder message = new StringBuilder("ÂΩìÂâçÈôÑ‰ª∂:\n");
        List<AttachmentManager.AttachedFile> files = attachmentManager.getAttachedFiles();

        if (files.isEmpty()) {
            message.append("Êó†ÈôÑ‰ª∂");
        } else {
            for (int i = 0; i < files.size(); i++) {
                message.append((i + 1)).append(". ").append(files.get(i).getFilePath()).append("\n");
            }
        }

        message.append("\n‰ΩøÁî® /@Êñá‰ª∂Ë∑ØÂæÑ ÂëΩ‰ª§Ê∑ªÂä†ÈôÑ‰ª∂");

        JOptionPane.showMessageDialog(this, message.toString(), "ÈôÑ‰ª∂ÁÆ°ÁêÜ", JOptionPane.INFORMATION_MESSAGE);
    }

    private void handleClearCommand() {
        // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩïÂíåËæìÂÖ•Ê°Ü
        onClearChat.run();
        inputTextArea.setText("");
        attachmentManager.clearAll();
        updateAttachmentButton();
    }

    private void handleAttachmentCommand(String filePath) {
        boolean added = attachmentManager.addFile(filePath);
        if (added) {
            updateAttachmentButton();
            // ÂèØ‰ª•ÊòæÁ§∫‰∏Ä‰∏™ÁÆÄÁü≠ÁöÑÊèêÁ§∫
            attachButton.setToolTipText("ÈôÑ‰ª∂ (" + attachmentManager.getAttachmentCount() + ") - Â∑≤Ê∑ªÂä†: " + filePath);
        } else {
            attachButton.setToolTipText("ÈôÑ‰ª∂ (" + attachmentManager.getAttachmentCount() + ") - Ê∑ªÂä†Â§±Ë¥•: " + filePath);
        }

        // 3ÁßíÂêéÊÅ¢Â§çÊ≠£Â∏∏ÊèêÁ§∫
        Timer timer = new Timer(3000, e -> updateAttachmentButton());
        timer.setRepeats(false);
        timer.start();
    }

    private void updateAttachmentButton() {
        int count = attachmentManager.getAttachmentCount();
        attachButton.setToolTipText("ÈôÑ‰ª∂ (" + count + ")");

        // Â¶ÇÊûúÊúâÈôÑ‰ª∂ÔºåÊîπÂèòÊåâÈíÆÊ†∑Âºè
        if (count > 0) {
            attachButton.setText("üìé(" + count + ")");
        } else {
            attachButton.setText("üìé");
        }
    }
    
    /**
     * ËÆæÁΩÆËæìÂÖ•Ê°ÜÁÑ¶ÁÇπ
     */
    public void focusInput() {
        inputTextArea.requestFocus();
    }
    
    /**
     * Ëé∑ÂèñÂΩìÂâçËæìÂÖ•ÁöÑÊñáÊú¨
     */
    public String getCurrentText() {
        return inputTextArea.getText();
    }
    
    /**
     * ËÆæÁΩÆËæìÂÖ•Ê°ÜÊñáÊú¨
     */
    public void setText(String text) {
        inputTextArea.setText(text);
    }
    
    /**
     * Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
     */
    public void clearInput() {
        inputTextArea.setText("");
    }
}
